{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://synosx.dev/schemas/replay.registry.schema.json",
  "title": "SynOSX Audit Replay Registry",
  "type": "object",
  "additionalProperties": false,
  "required": ["version", "policy", "description", "updated_at", "entries"],

  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },

    "policy": { "type": "string", "minLength": 1 },

    "description": { "type": "string", "minLength": 1 },

    "updated_at": { "type": "string", "format": "date-time" },

    "entries": {
      "type": "object",
      "minProperties": 1,
      "additionalProperties": { "$ref": "#/$defs/entry" },

      "propertyNames": {
        "type": "string",
        "pattern": "^[a-z0-9][a-z0-9_\\-:.]{2,127}$"
      }
    }
  },

  "$defs": {
    "entry": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "trace_id",
        "intent",
        "actor",
        "dag",
        "firewall",
        "audit",
        "verdict",
        "evidence_hash",
        "recorded_at",
        "media",
        "notes"
      ],

      "properties": {
        "trace_id": {
          "type": "string",
          "minLength": 3,
          "pattern": "^[A-Za-z0-9][A-Za-z0-9_\\-:.]{2,127}$"
        },

        "intent": { "type": "string", "minLength": 1 },

        "actor": { "type": "string", "minLength": 1 },

        "dag": { "type": "string", "enum": ["OK", "FAIL", "UNKNOWN"] },

        "firewall": { "type": "string", "enum": ["GRANTED", "DENIED", "UNKNOWN"] },

        "audit": { "type": "string", "enum": ["HASHED", "MISSING", "UNKNOWN"] },

        "verdict": { "type": "string", "enum": ["VERIFIED", "BLOCKED", "FAILED"] },

        "evidence_hash": {
          "type": "string",
          "pattern": "^sha256:[A-Za-z0-9._\\-]{6,256}$"
        },

        "recorded_at": { "type": "string", "format": "date-time" },

        "media": { "$ref": "#/$defs/media" },

        "notes": { "type": "string", "minLength": 1 }
      },

      "allOf": [
        {
          "if": {
            "properties": { "verdict": { "const": "BLOCKED" } },
            "required": ["verdict"]
          },
          "then": {
            "properties": {
              "firewall": { "enum": ["DENIED", "UNKNOWN"] }
            }
          }
        }
      ]
    },

    "media": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "src", "poster"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["video/mp4"]
        },

        "src": {
          "type": "string",
          "pattern": "^(replay/).+\\.mp4$"
        },

        "poster": {
          "type": "string",
          "pattern": "^(replay/).+\\.(jpg|jpeg|png|webp)$"
        },

        "duration_sec": {
          "type": "integer",
          "minimum": 1,
          "maximum": 7200
        }
      }
    }
  }
}
